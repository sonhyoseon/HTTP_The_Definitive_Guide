# 내용 협상과 트랜스코딩
하나의 URL이 여러 리소스에 대응할 필요가 있는 경우가 있다.
여러 언어로 제공하려 하는 웹 사이트에서 서버가 영어 사용자에게는 영어, 한국어 사용자에게는 한국어를 보내준다면 이상적일 것이다.
HTTP는 이를 지원하기 위해 내용 협상 이라는 방법을 사용한다.
이 방법으로 하나의 URL이 여러 리소스 중 적합한 것에 대응되도록 할 수 있다.

## 17.1 내용 협상 기법
서버에 있는 페이지들 중 어떤 것이 클라이언트에게 맞는지 판단하는 세 가지 다른 방법이 있다.
 
  |협상기법|상세|장점|단점|
  |---|---|---|---|
  |클라이언트 주도|클라이언트가 요청 시 서버가 선택지 제시|- 서버 구현 용이 <br> - 클라이언트가 최선의 선택 가능|대기 시간 증가 <br> (최소 2번 요청 필요)|
  |서버 주도|- 서버가 요청 헤더 검증해 제공 버전 선택 <br> - 클라이언트는 선호도(q값) 제공 <br> - 서버는 `Vary` 헤더로 검증 헤더 안내 | 클라이언트 주도보다 빠름|헤더에 맞는 것 없으면 서버가 추측해야|
  |투명|투명한 중간장치가 서버 대신 협상 <br> (주로 프록시 캐시)|- 서버의 협상부담 절감 <br> -클라이언트 주도보다 빠름|정형화된 명세 부재|
## 17.2 클라이언트 주도 협상
서버에게 있어 가장 쉬운 방법은 클라이언트가 선택하도록 하는 것이다.
구현하기 쉽다는 장점이 있지만 단점으로는 여러 번의 요청이 필요하다.

## 17.3 서버 주도 협상
클라이언트 주도 협상은 클라이언트와 서버 사이의 커뮤니케이션을 증가시킨다.
이러한 커뮤니케이션을 줄이기 위해서는 자신이 무엇을 선호하는지에 대한 충분한 정보를 서버에게 주어야한다.

HTTP 서버가 클라이언트에게 보내줄 적절한 응답을 계산하기 위해 사용하는 매커니즘은 다음 두 가지다.
- 내용 협상 헤더들을 살펴본다
- 내용 협상 헤더 외의 다른 헤더들을 살펴본다.

### 17.3.1 내용 협상 헤더
| 헤더 | 설명
|---|:---:|
| `Accept` | 서버가 어떤 미디어 타입으로 보내도 되는지 알려줌
| `Accept-Language` | 서버가 어떤 언어로 보내도 되는지 알려줌
| `Accept-Charset` | 서버가 어떤 차셋으로 보내도 되는지 알려줌
| `Accept-Encoding` | 서버가 어떤 인코딩으로 보내도 되는지 알려줌
 위 헤더는 엔티티 헤더와 비슷하지만
 엔티티 헤더는 필요한 메시지 본문의 속성을 가리키지만
내용 협상 헤더는 문서들의 여러 버전 중 하나를 선택하는 것을 돕는다.

### 17.3.2 내용 협상 헤더의 품질 값
HTTP 프로토콜은 클라이언트가 각 선호의 카테고리마다 여러 선택 가능한 항목을 선호도와 함께 나열할 수 있도록 품질 값을 정의하였다.
q값은  0.0부터 1.0 까지의 값을 가질 수 있다.

### 17.3.3 그 외의 헤더들에 의해 결정
서버는 또한 User-Agent와 같은 클라이언트의 다른 요청 헤더들을 이용해 알맞은 요청을 만들어내려고 시도할 수 있다.

### 17.3.4 아파치의 내용 협상
만약 색인 페이지를 여러 가지 버전으로 제공해 주려고 한다면 우선 콘텐츠 제공자가 각각의 버전에 해당하는 파일들을 아파치 서버의 적절한 디렉토리에 모두 넣어주어야 한다.
그 후 두가지 방법 중 하나로 내용 협상을 동작시킬 수 있다.
- 웹 사이트 디렉터리에서 베리언트를 갖는 웹 사이트의 각 URI를 위한 type-map 파일을 만든다.
- 아파치가 그 디렉터리에 대해 자동으로 type-map 파일들을 위한 파일 접미사를 명시한 핸들러를 추가한다.

### 17.3.5 서버 측 확장
마이크로소프트의 액티브 서버 페이지와 같이 서버 쪽에서 확장을 하는 방법이 있다.

## 17.4 투명 협상
투명 협상은 클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 클라이언트와의 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거한다.

서버는 Vary 헤더를 정의해 중개자에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 프락시에게 알려준다.

캐시 프락시는 단일한 URL을 통해 접근할 수 있는 문서의 여러 다른 사본을 저장할 수 있다.
만약 서버가 그들의 캐시에 대한 의사결정 프로세스를 캐시에게 알려주었다면, 캐시는 서버의 입장에서 클라이언트와 협상할 수 있다.

### 17.4.1 캐시와 얼터네이트
콘텐츠를 캐시하는 것은 그 콘텐츠가 나중에 재사용될 것이라고 예상하기 때문이다.
캐시는 클라이언트에게 올바로 캐시된 응답을 돌려주기 위해, 서버가 응답을 돌려줄 때 사용했던 의사결정 로직의 상당 부분을 그대로 사용해야 한다.

### 17.4.2 Vary 헤더
HTTP Vary 응답 헤더는 서버가 문서를 선택하거나 커스텀 콘텐츠를 생성할 때 고려한 클라이언트 요청 헤더 모두를 나열한다.
새 요청이 도착했을 때 캐시는 내용 협상 헤더들을 이용해 가장 잘 맞는것을 찾는다.
그러나 캐시가 문서를 클라이언트에게 제공해 줄 수 있게 되기 전에 캐시는 Vary 헤더가 들어있는지 확인한다.

## 17.5 트랜스코딩
서버가 클라이언트의 요구에 맞는 문서를 아예 갖고 있지 않다면 트랜스코딩이라는 방법을 사용한다.
| 전 | 후
|---|:---:|
| `HTML 문서` | WML 문서
| `고해상도 이미지` | 저해상도 이미지
| `64K색 이미지` | 흑백 이미지
| `프레임을 포함한 복잡한 페이지` | 프레임이나 이미지가 없는 단순한 텍스트 페이지
| `자바 애플릿이 있는 HTML 페이지` | 자바 애플릿이 없는 페이지
| `광고가 있는 페이지` | 광고가 없는 페이지
트랜스 코딩에는 포맷 변환, 정보 합성, 내용 주입의 세 종류가 있다.

### 17.5.1 포맷 변환
포맷 변환은 데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환하는 것이다.

### 17.5.2 정보 합성
문서에서 정보의 요점을 추출하는 것을 정보 합성 이라고 한다.
간단한 예로 문서의 개요 생성이나 페이지에서 광고 및 로고 제거를 들 수 있다.

### 17.5.3 콘텐츠 주입
위 두종류의 트랜스코딩은 일반적으로 양을 줄이지만 반대로 양을 늘리는 내용 주입 트랜스코딩도 있다.
자동 광고 생성이나 사용자 추적 시스템 등에 사용된다.

### 17.5.4 트랜스코딩 vs. 정적으로 미리 생성하기
트랜스코딩의 대안은 미리 사본을 만들어 두는 것이다.
그러나 페이지에 대한 작은 변화도 여러 수정을 요구하기 때문에 현실적으로 효과적이지 못하다.
